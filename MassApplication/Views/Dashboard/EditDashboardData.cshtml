@model MassApplication.Models.Dashboard_class
@{
    ViewBag.Title = "Edit Dashboard";
}

<link rel="stylesheet" href="~/GraphStyles/css/styles.css" />
<link rel="stylesheet" href="~/MasterStyles/DaterangePicker/daterangepicker.css" />
<link rel="stylesheet" href="~/Content/jquery-ui.css" />
<link rel="stylesheet" href="~/GraphStyles/css/spectrum.css" />

<script src="~/MasterStyles/DaterangePicker/daterangepicker.js"></script>
<link rel="stylesheet" href="~/GraphStyles/GridStack/dist/gridstack.min.css" />
<style>
    label {
        margin: 10px 15px;
    }

    .frame {
        top: 0px;
        left: 0px;
        right: 0px;
        bottom: 0px;
        padding: 20px;
        /*min-width: 400px;
        min-height: 300px;*/
        position: absolute;
        overflow-x: hidden;
        overflow-y: auto;
        /* border: 4px dashed #000;*/
    }

    .tile {
        position: relative;
        /*background: #444;
        box-shadow: 0px 0px 10px #f00;
        border: 2px solid #f00;
        border-radius: 10px;*/
    }

    .del-tile {
        height: 32px;
        width: 32px;
        background: #600;
        color: #fff;
        border-radius: 5px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        font: bold 20px arial;
    }

    .grid-stack > .grid-stack-item > .grid-stack-item-content {
        overflow-x: hidden;
        overflow-y: hidden;
    }

    .card1 {
        /*background-color: #4bc06a;*/
        border-radius: 4px;
        padding: 12px 20px;
        margin: 12px;
        text-decoration: none;
        width: 281px;
        color: #fff;
        /* cursor: grab; */
        cursor: -webkit-grab;
        cursor: -moz-grab;
        text-transform: capitalize;
    }

    #myTabEdit a.card1:hover img {
        filter: brightness(0) invert(1);
    }

    #myTabEdit .nav-tabs .nav-link.active img {
        filter: brightness(0) invert(1);
    }
</style>
<style>
    .card-title {
        font-weight: normal;
    }

    .settingTag, #IconShow, #showchartlegend, #AxisShow, #GridlinesShow {
        cursor: pointer;
    }

    .picker {
        border-radius: 5px;
        width: 25px;
        height: 20px;
        cursor: pointer;
        -webkit-transition: all linear .2s;
        -moz-transition: all linear .2s;
        /* -ms-transition: all linear .2s;*/
        -o-transition: all linear .2s;
        transition: all linear .2s;
        border: thin solid #eee;
    }

        .picker:hover {
            transform: scale(1.1);
        }

    .sp-preview {
        border: none;
    }

    .sp-replacer {
        width: 50px;
        background: #f4f6f9;
        /* background: white;*/
        border: none;
    }

    .sp-preview, .sp-alpha, .sp-thumb-el {
        width: 60%;
    }

    .sidebar {
        /*height: 100%;*/
        /* height: 520px;*/
        height: 520px;
        width: 0;
        position: fixed;
        z-index: 1;
        /* top: 0;*/
        right: 0;
        /*left: 0;*/
        /* top: 95px;*/
        /* top: 129px;*/
        background-color: #f4f6f9;
        /* background-color: #fff;*/
        overflow-x: hidden;
        transition: 0.5s;
        padding-top: 20px;
    }

        .sidebar a {
            /* padding: 8px 8px 8px 32px;*/
            padding: 5px 5px 10px 2px;
            text-decoration: none;
            font-size: 14px;
            /* color: #818181;*/
            color: #314152;
            display: block;
            transition: 0.3s;
        }

            .sidebar a:hover {
                /*  color: #f1f1f1;*/
            }

    .dropdown-toggle::after {
        /* margin-left: 9em;*/
        float: right;
    }

    .sidebar .closebtn {
        padding: 10px 2px 0 2px;
        position: absolute;
        top: 0;
        right: 5px;
        font-size: 26px;
        /* margin-left: 50px;*/
    }

    .openbtn {
        /*font-size: 20px;*/
        cursor: pointer;
        /* background-color: #111;*/
        color: white;
        /* padding: 10px 15px;*/
        border: none;
    }

        .openbtn:hover {
            background-color: #444;
        }

    #main {
        transition: margin-left .5s;
        padding: 16px;
    }
</style>
<style>
    .small-boxx .headerText {
        font-size: 25px;
        font-weight: 600;
    }

    .icon {
        margin-right: 10px;
    }

    .small-boxx .icon {
        color: rgba(0, 0, 0, 0.15);
        z-index: 0;
    }

        .small-boxx .icon > i {
            font-size: 90px;
            position: absolute;
            right: 15px;
            top: 15px;
            transition: -webkit-transform 0.3s linear;
            transition: transform 0.3s linear;
            transition: transform 0.3s linear, -webkit-transform 0.3s linear;
        }

            .small-boxx .icon > i.fa, .small-boxx .icon > i.fas, .small-boxx .icon > i.far, .small-boxx .icon > i.fab, .small-boxx .icon > i.fal, .small-boxx .icon > i.fad, .small-boxx .icon > i.ion {
                font-size: 70px;
                top: 20px;
            }

        .small-boxx .icon svg {
            font-size: 70px;
            position: absolute;
            right: 15px;
            top: 15px;
            transition: -webkit-transform 0.3s linear;
            transition: transform 0.3s linear;
            transition: transform 0.3s linear, -webkit-transform 0.3s linear;
        }

    .small-boxx:hover {
        text-decoration: none;
    }

        .small-boxx:hover .icon > i, .small-boxx:hover .icon > i.fa, .small-boxx:hover .icon > i.fas, .small-boxx:hover .icon > i.far, .small-boxx:hover .icon > i.fab, .small-boxx:hover .icon > i.fal, .small-boxx:hover .icon > i.fad, .small-boxx:hover .icon > i.ion {
            -webkit-transform: scale(1.1);
            transform: scale(1.1);
        }

        .small-boxx:hover .icon > svg {
            -webkit-transform: scale(1.1);
            transform: scale(1.1);
        }

    @@media (max-width: 767.98px) {
        .small-boxx {
            text-align: center;
        }

            .small-boxx .icon {
                display: none;
            }

            .small-boxx p {
                font-size: 12px;
            }
    }
</style>

<body style="overflow:hidden">
    <section class="content">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-md-12">
                    <div style="margin:5px;">
                        <button type="button" class="btn btn-dash" onclick="BtnEditDashboard(@Model.dashboard_id)" data-toggle="modal" style="padding:3px 15px;float:right;"><i class="fas fa-save"></i> Save </button>
                        <button type="button" class="btn btn-success" onclick="BtnBackDashboard()" style="padding: 4px 20px; float: right; margin-right: 5px; border-radius: 5px; font-weight: 400"><i class="fa fa-backward"></i> Back </button>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="page-container" style="width:100%">
                    <div class="master">
                        @Html.HiddenFor(model => model.dashboard_id, new { id = "edit_dashboard_id" })
                        <div class="row">
                            <div class="col-sm-4">
                                <label ID="Lbl_dbname"> Dashboard Name: </label>
                            </div>
                            <div class="col-sm-8">
                                <input id="edit_Dashboard_name" class="form-control drop_down_daily" type="text" value="@Model.dashboard_name" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4">
                                <label ID="Lbl_dbdescription"> Dashboard Description: </label>
                            </div>
                            <div class="col-sm-8">
                                <textarea id="edit_Dashboard_description" class="form-control" rows="2">@Model.dashboard_description</textarea>
                                @*@Html.TextAreaFor(model => model.report_description, new { @class = "form-control drop_down_daily" })*@
                            </div>
                        </div>
                    </div>
                    <div class="panel-container pt-3">
                        <div class="panel-left card contact-trap" id="dashedit" style="height: 370px;">
                            <div class="row">
                                <ul class="nav nav-tabs border-bottom-0" id="myTabEdit" role="tablist">
                                    @foreach (var m in ViewBag.kpiChartItems)
                                    {
                                        <li class="nav-item">
                                            <a class="card1 nav-link" draggable="true" ondragstart="drag(event)" data-toggle="modal" data-target="#userdefine" data-id="@m.kpi_id" data-val-number="@m.chart_type" data-val="@m.kpi_query_id" data-data-val="@m.kpi_name">
                                                <div class="media">
                                                    <img class="mr-3" src='@Url.Content(m.chart_image)' style="width:44px" alt="Generic placeholder image" />
                                                    <div class="media-body">
                                                        <h5>@m.kpi_name</h5>
                                                        <input type="hidden" id="@m.kpi_id" name="@m.kpi_id" value="@m.json_property" />
                                                        <p>Correlations, proportions </p>
                                                    </div>
                                                </div>
                                            </a>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                        <div class="splitter"></div>
                        <div class="panel-right card" id="div2" style="min-width:25%; max-height:100%;">
                            <div id="container" class="frame no2" ondrop="drop(event)" ondragover="allowDrop(event)">
                                <div id="grid" class="grid-stack grid-stack-12"></div>
                            </div>
                            <div id="mySidebar" class="sidebar propertyBar" style="overflow-y: scroll">
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </section>

</body>

<script src="~/GraphStyles/js/adminlte.js"></script>
<script src="~/GraphStyles/GridStack/dist/jquery.min.js"></script>
<script src="~/Scripts/jquery-ui.js"></script>
<script src="~/GraphStyles/GridStack/dist/lodash.min.js"></script>
<script src="~/GraphStyles/GridStack/dist/gridstack.min.js"></script>
<script src="~/GraphStyles/js/spectrum.js"></script>
<script src="~/Scripts/Chart-js/chart.js"></script>
<script src="~/MasterStyles/js/StickyScript.js"></script>

<script>
    $(document).ready(function () {
        var kpiItems = @Html.Raw(Json.Encode(Model.kpiList));
        getReadyData(kpiItems);
    });
</script>
<script>
    function DrawTheTable(tval, data, qid, chartType, chartId) {
         $.ajax({
                type: "POST",
                //contentType: false,
                url: '@Url.Content("~/DashBoard/KpiTabularData?QueryId=")' + qid + "&chartparams=" + data,
                success: function (modelval) {

                    var mainTab = "myChart" + chartId;
                    createdynamictable(modelval, mainTab, chartId);
                }
            });

    };
    function DrawTheLabel(tval, data, qId, chartType, chartId, chart_caption, chart_color) {
        data = data.replace("#", "");
           $.ajax({
                type: "POST",
                url: '@Url.Content("~/DashBoard/KpiLabelData?QueryId=")' + qId + "&chartparams=" + data,
                success: function (modelval) {
                    var modelData = modelval.Success;
                    var modelColor = modelval.Message;
                    var modelCaption = modelval.DataVal;
                    var modelPosition = modelval.DataVal1;
                    var mainTab = "myChart" + chartId;
                    if (modelPosition == null || modelPosition == "") {
                        createdynamiclabel(modelData, mainTab, modelCaption, modelColor, chartId);
                    }
                    else {
                        createdynamicMultilabel(modelData, mainTab, modelCaption, modelPosition, modelColor, chartId);
                    }
                }
            });

    };
</script>
<script>
    function BtnBackDashboard() {
    @*var dashboard_url = '@Url.Content("~/DashBoard/DashboardList")';*@
        var dashboard_url = '@Url.Content("~/Dynamic/Index?menu_name=Dashboard")';
    window.location.href = dashboard_url;
    //window.open(url, '_blank');
    }
    function BtnEditDashboard(id) {
        var validEntry = true;
        var htmlEditdata = $('#grid').html();
        //console.log("HTMLDATA:", htmlEditdata);
        if (htmlEditdata == '') {
            validEntry = false;
            alert('Please plot atleast one chart on panel!!!');
        }
        else {
            validEntry = true;
        }


        var list = [];
        var items = $('.plainCard');
        //var element = document.getElementById('some-id'); //getBoundingClientRect();
        //var position = items.getBoundingClientRect(); this.getBoundingClientRect();
        //var x = position.left;
        //var y = position.top;
        $(items).each(function () {
            var position = $(this).offset();
            console.log("position:", position);
            //var position = items.getBoundingClientRect();
            var myClient = $(this)[0].getBoundingClientRect();
            console.log(myClient.top, myClient.left, myClient.bottom, myClient.right);

            var myPosY = $(this).offset().left - $('.panel-container').offset().left;
            var myPosX = $(this).offset().top - $('.panel-container').offset().top;
            console.log("position:", myPosY, " ", myPosX);

            var keyid = $(this).attr("id");
            var current_sticky = null;
            var tmp_obj = json_DataProperty.find(o => o.key === keyid);
            if (tmp_obj != undefined && tmp_obj != null) {
                current_sticky = tmp_obj.value;
                var objData = {};
                //console.log("current_sticky", current_sticky);
                for (let i = 0; i < current_sticky.length; i++) {
                    //objData.push(
                    //    [current_sticky[i]["key"]], current_sticky[i]["value"]
                    //);
                    //objData.push({
                    //    key: current_sticky[i]["key"],
                    //    value: current_sticky[i]["value"]
                    //});

                    Object.assign(objData, { [current_sticky[i]["key"]]: current_sticky[i]["value"] });

                }

                objData = JSON.stringify(objData);
                //console.log("objData", objData);
            }
            else {
                objData = null;
            }

            //var position = $(this).position();
            //var myClient = $(items)[0].getBoundingClientRect();
            var chartItem = {
                kpi_id: $(this).attr("data-id"),
                chart_container: $(this).attr("id"),
                chart_type: $(this).attr("data-val-number"),
                kpi_query_id: $(this).attr("data-val"),
                //chart_top : $(this).css("top"),
                //chart_left: $(this).css("left"),
                //chart_bottom : $(this).css("bottom"),
                //chart_right: $(this).css("right"),
                chart_height: $(this).css("height"),
                chart_width: $(this).css("width"),
                //chart_left: $(this).offset().left,
                //chart_top: $(this).offset().top,
                chart_left: myClient.left,
                chart_top: myClient.top,
                chart_bottom: myClient.bottom,
                chart_right: myClient.right,
                //chart_bottom: $(this).offset().top + $(this).height(),
                //chart_right: $(this).offset().left + $(this).width(),
                //chart_height: ($(this).height() / $(window).height())*100,
                //chart_width: ($(this).width() / $(window).width())*100
                kpi_property: objData

            }
            list.push(chartItem);
        });

        //console.log("list:", list);

        if (validEntry) {

            var newDataVal = {
                dashboard_id: id,
                dashboard_name: $("#edit_Dashboard_name").val(),
                dashboard_description: $('#edit_Dashboard_description').val(),
                kpiList: list
            }

            console.log("newDataVal:", newDataVal);

            $.ajax({
                type: 'POST',
                url: '@Url.Content("~/DashBoard/EditDbData")',
                data: JSON.stringify(newDataVal),
                contentType: 'application/json',
                success: function (data) {
                    if (data.startsWith("ERROR")) {
                        var res = data.split(";");
                        var error = '';
                        if (res.length > 1) {
                            error = res[1];
                        } else {
                            error = data;
                        }
                        alert(error);
                    }
                    else {
                        alert('Successfully saved!!!');
                        list = [];
                    @*var dashboard_url = '@Url.Content("~/DashBoard/DashboardList")';*@
                        var dashboard_url = '@Url.Content("~/Dynamic/Index?menu_name=Dashboard")';
                        window.location.href = dashboard_url;
                        //location.reload();
                    }
                },
                error: function (error) {
                    alert("Error");
                }

            });

        }
    }
</script>