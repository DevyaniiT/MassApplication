@model MassApplication.Models.Report_Class

<style>
    .tab-pane {
        margin-top: 10px;
    }
    table td.qry_id { display: none; }
    table td.param_id { display: none; }
</style>

@using (Html.BeginForm("EditRptData", "Report", FormMethod.Post, new { target = "_blank" }))
{
    @Html.AntiForgeryToken()


    <div class="form-horizontal">

        <ul class="nav nav-tabs" id="tabContent">
            <li class="active"><a href="#reportTab" data-toggle="tab">Report Details</a></li>
            <li><a href="#paramsTab" data-toggle="tab">Parameters Details</a></li>
            <li><a href="#connectionTab" data-toggle="tab">Connection Details</a></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane active" id="reportTab">
                <div class="master">
                    @Html.HiddenFor(model => model.report_id, new { id = "rpt_id" })
                    <div class="row">
                        <div class="col-sm-4">
                            <label ID="Lbl_name"> Report Name: </label>
                        </div>
                        <div class="col-sm-8">
                            <input id="report_name" class="form-control drop_down_daily" type="text" value="@Model.report_name" />
                            @*@Html.TextBoxFor(model => model.report_name, new { @class = "rpt_name form-control drop_down_daily" })*@
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-4">
                            <label ID="Lbl_description"> Report Description: </label>
                        </div>
                        <div class="col-sm-8">
                            <textarea id="report_description" class="form-control" rows="2">@Model.report_description</textarea>
                            @*@Html.TextAreaFor(model => model.report_description, new { @class = "form-control drop_down_daily" })*@
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-4">
                            <label ID="Lbl_path"> Report File: </label>
                        </div>
                        <div class="col-md-8">
                            @{
                                String filepathname = Server.MapPath(Model.report_path) + Model.report_file;
                            }
                            <input id="report_file" class="form-control drop_down_daily" type="text" value="@Model.report_file" />
                            @*<input id="report_file" type="file" value="@filepathname"/>*@
                            @*@Html.TextBoxFor(model => model.report_file, new { @class = "form-control drop_down_daily" })*@
                        </div>
                    </div>
                    <br/>
                    @*<h4>
                        Report Query
                    </h4>*@
                    <table id="querytabledata" class="table table-bordered table-responsive-md table-striped">
                        <thead>
                            <tr col="2">
                                @*<th>ID</th>*@
                                <th>Type</th>
                                <th>Parameter Name</th>
                                <th class="text-center">Query</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var qryitem in Model.query_data)
                            {
                            <tr col="2">
                                <td class="qry_id col-md-2" contenteditable="false">
                                    @qryitem.queryId
                                </td>
                                <td class="qry_type col-md-3" contenteditable="true">
                                    @qryitem.type
                                </td>
                                <td class="qry_parameter col-md-3" contenteditable="true">
                                    @qryitem.parameterData
                                </td>
                                <td class="script col-md-7" contenteditable="true">
                                    <textarea id="report_query" class="report_query form-control" rows="4">@qryitem.query_qrydata</textarea>
                                </td>
                            </tr>
                            }
                        </tbody>
                    </table>

                </div>
            </div>
            <div class="tab-pane" id="paramsTab">
                <div class="details">
                    <table id="reportItems" class="table table-bordered table-responsive-md table-striped text-center">
                        <thead>
                            <tr>
                                @*<th class="text-center">ID</th>*@
                                <th class="text-center">Label</th>
                                <th class="text-center">Variable</th>
                                <th class="text-center">Type</th>
                                <th class="text-center">Method</th>
                                <th class="text-center">Query</th>
                                @*<th class="text-center">Remove</th>*@
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var items in Model.param_data)
                            {
                                <tr>
                                    <td class="param_id pt-3-half" contenteditable="false">
                                        @items.param_id
                                    </td>
                                    <td class="labelTxt pt-3-half" contenteditable="true">
                                        @items.param_label
                                    </td>
                                    <td class="variable pt-3-half" contenteditable="true">
                                        @items.param_variable
                                    </td>
                                    <td class="type pt-3-half" contenteditable="true">
                                        @items.param_type
                                    </td>
                                    <td class="method pt-3-half" contenteditable="true">
                                        @items.param_method
                                    </td>
                                    <td class="query pt-3-half" contenteditable="true">
                                        @items.param_query
                                    </td>
                                    @*<td>
                                            <span class="table-remove">
                                                <button type="button"
                                                        class="btn btn-danger btn-rounded btn-sm my-0">
                                                    Remove
                                                </button>
                                            </span>
                                        </td>*@
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane" id="connectionTab">
                        @Html.HiddenFor(modelItem => Model.connData.connection_id, new { id = "connect_id" })
                        <div class="row">
                            <div class="col-sm-3">
                                <label ID="Lbl_dsn"> DSN: </label>
                            </div>
                            <div class="col-sm-9">
                                <input id="conn_dsn_name" class="form-control drop_down_daily" type="text" value="@Model.connData.dsn_name" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-3">
                                <label ID="Lbl_username"> User Name: </label>
                            </div>
                            <div class="col-sm-9">
                                <input id="conn_user_name" class="form-control drop_down_daily" type="text" value="@Model.connData.user_id" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-3">
                                <label ID="Lbl_pwd"> Password: </label>
                            </div>
                            <div class="col-sm-9">
                                <input id="conn_password" class="form-control drop_down_daily" type="password" value="@Model.connData.password" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-3">
                                <label ID="Lbl_db_name"> Database Name: </label>
                            </div>
                            <div class="col-sm-9">
                                <input id="conn_db_name" class="form-control drop_down_daily" type="text" value="@Model.connData.db_schema_name" />
                            </div>
                        </div>
            </div>
        </div>

        <div style="padding:10px 0; text-align:right">
            <input id="submitEditDetail" type="button" value="Save" class="btn btn-warning" style="padding:10px 20px" />
        </div>
    </div>

}

<script>
    $('.nav li').click(function (e) {

        $('.nav li').removeClass('active');

        var $this = $(this);
        if (!$this.hasClass('active')) {
            $this.addClass('active');
        }
        //e.preventDefault();
    });
</script>
<script>
    $('#submitEditDetail').click(function () {
        var param_list = [];
        $('#reportItems tbody tr').each(function (index, ele) {
            var param_rptItem = {
                param_id: $('.param_id', this).text(),
                param_type: $('.type', this).text(),
                param_method: $('.method', this).text(),
                param_label: $('.labelTxt', this).text(),
                param_variable: $('.variable', this).text(),
                param_query: $('.query', this).text()
            }
            param_list.push(param_rptItem);

        })
        var query_list = [];
        $('#querytabledata tbody tr').each(function (index, ele) {
            var qry_rptItem = {
                queryId: $('.qry_id', this).text(),
                type: $('.qry_type', this).text(),
                parameterData: $('.qry_parameter', this).text(),
                //query_qrydata: $('.script', this).text(),
                query_qrydata: $('textarea.report_query', this).val(),
            }

            query_list.push(qry_rptItem);

        })

        var conndata = {
            connection_id: $('#connect_id').val().trim(),
            dsn_name: $('#conn_dsn_name').val().trim(),
            user_id: $('#conn_user_name').val().trim(),
            password: $('#conn_password').val().trim(),
            db_schema_name: $('#conn_db_name').val().trim()
        }

        var data = {
            report_id: $('#rpt_id').val().trim(),
            report_name: $('#report_name').val().trim(),
            report_description: $('#report_description').val().trim(),
            report_query: $('#report_query').val().trim(),
            report_file: $('#report_file').val().replace(/.*(\/|\\)/, ''),
            param_data: param_list,
            query_data: query_list,
            connData: conndata
        }

        //alert(data);

        $.ajax({
            type: 'POST',
            url: '@Url.Content("~/Report/EditRptData")',
            data: JSON.stringify(data),
            contentType: 'application/json',
            success: function (data) {
                 if (data.startsWith("ERROR")) {
                      var res = data.split(";");
                      var error = '';
                      if (res.length > 1) {
                          error = res[1];
                      } else {
                          error = data;
                      }
                      alert(error);
                 }
                 else {
                       alert('Successfully saved!!!');
                       param_list = [];
                       query_list = [];
                       location.reload();
                 }
            },
            error: function (error) {
                alert("Error");
            }

        });


    });
</script>



