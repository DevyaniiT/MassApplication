@{
    ViewBag.Title = "Index";
}

<link rel="stylesheet" href="~/GraphStyles/css/styles.css" />
<link rel="stylesheet" href="~/MasterStyles/DaterangePicker/daterangepicker.css" />
<link rel="stylesheet" href="~/Content/jquery-ui.css" />
<link rel="stylesheet" href="~/GraphStyles/css/spectrum.css" />

<script src="~/MasterStyles/DaterangePicker/daterangepicker.js"></script>
<link rel="stylesheet" href="~/GraphStyles/GridStack/dist/gridstack.min.css" />

<style>
    .frame {
        top: 0px;
        left: 0px;
        right: 0px;
        bottom: 0px;
        padding: 20px;
        /*min-width: 400px;
        min-height: 300px;*/
        position: absolute;
        overflow-x: hidden;
        overflow-y: auto;
        /* border: 4px dashed #000;*/
    }

    .tile {
        position: relative;
        /*background: #444;
        box-shadow: 0px 0px 10px #f00;
        border: 2px solid #f00;
        border-radius: 10px;*/
    }

    .del-tile {
        height: 32px;
        width: 32px;
        background: #600;
        color: #fff;
        border-radius: 5px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        font: bold 20px arial;
    }

    .grid-stack > .grid-stack-item > .grid-stack-item-content {
        /* overflow-x: hidden;
        overflow-y: hidden;*/
    }

    .card1 {
        /*background-color: #4bc06a;*/
        border-radius: 4px;
        padding: 12px 20px;
        margin: 12px;
        text-decoration: none;
        width: 281px;
        color: #fff;
        /* cursor: grab; */
        cursor: -webkit-grab;
        cursor: -moz-grab;
        text-transform: capitalize;
    }

    #myTabInner a.card1:hover img {
        filter: brightness(0) invert(1);
    }

    #myTabInner .nav-tabs .nav-link.active img {
        filter: brightness(0) invert(1);
    }
</style>
<style>
    .card-title {
        font-weight: normal;
    }

    .settingTag, #IconShow, #showchartlegend, #AxisShow, #GridlinesShow {
        cursor: pointer;
    }

    .picker {
        border-radius: 5px;
        width: 25px;
        height: 20px;
        cursor: pointer;
        -webkit-transition: all linear .2s;
        -moz-transition: all linear .2s;
        /* -ms-transition: all linear .2s;*/
        -o-transition: all linear .2s;
        transition: all linear .2s;
        border: thin solid #eee;
    }

        .picker:hover {
            transform: scale(1.1);
        }

    .sp-preview {
        border: none;
    }

    .sp-replacer {
        width: 50px;
        background: #f4f6f9;
        /* background: white;*/
        border: none;
    }

    .sp-preview, .sp-alpha, .sp-thumb-el {
        width: 60%;
    }

    .sidebar {
        /*height: 100%;*/
        /* height: 520px;*/
        height: 520px;
        width: 0;
        position: fixed;
        z-index: 1;
        /* top: 0;*/
        right: 0;
        /*left: 0;*/
        /* top: 95px;*/
        /* top: 129px;*/
        background-color: #f4f6f9;
        /* background-color: #fff;*/
        overflow-x: hidden;
        transition: 0.5s;
        padding-top: 20px;
    }

        .sidebar a {
            /* padding: 8px 8px 8px 32px;*/
            padding: 5px 5px 10px 2px;
            text-decoration: none;
            font-size: 14px;
            /* color: #818181;*/
            color: #314152;
            display: block;
            transition: 0.3s;
        }

            .sidebar a:hover {
                /*  color: #f1f1f1;*/
            }

    .dropdown-toggle::after {
        /* margin-left: 9em;*/
        float: right;
    }

    .sidebar .closebtn {
        padding: 10px 2px 0 2px;
        position: absolute;
        top: 0;
        right: 5px;
        font-size: 26px;
        /* margin-left: 50px;*/
    }

    .openbtn {
        /*font-size: 20px;*/
        cursor: pointer;
        /* background-color: #111;*/
        color: white;
        /* padding: 10px 15px;*/
        border: none;
    }

        .openbtn:hover {
            background-color: #444;
        }

    #main {
        transition: margin-left .5s;
        padding: 16px;
    }
</style>
<style>
    .small-boxx .headerText {
        font-size: 25px;
        font-weight: 600;
    }

    .icon {
        margin-right: 10px;
    }

    .small-boxx .icon {
        color: rgba(0, 0, 0, 0.15);
        z-index: 0;
    }

        .small-boxx .icon > i {
            font-size: 90px;
            position: absolute;
            right: 15px;
            top: 15px;
            transition: -webkit-transform 0.3s linear;
            transition: transform 0.3s linear;
            transition: transform 0.3s linear, -webkit-transform 0.3s linear;
        }

            .small-boxx .icon > i.fa, .small-boxx .icon > i.fas, .small-boxx .icon > i.far, .small-boxx .icon > i.fab, .small-boxx .icon > i.fal, .small-boxx .icon > i.fad, .small-boxx .icon > i.ion {
                font-size: 70px;
                top: 20px;
            }

        .small-boxx .icon svg {
            font-size: 70px;
            position: absolute;
            right: 15px;
            top: 15px;
            transition: -webkit-transform 0.3s linear;
            transition: transform 0.3s linear;
            transition: transform 0.3s linear, -webkit-transform 0.3s linear;
        }

    .small-boxx:hover {
        text-decoration: none;
    }

        .small-boxx:hover .icon > i, .small-boxx:hover .icon > i.fa, .small-boxx:hover .icon > i.fas, .small-boxx:hover .icon > i.far, .small-boxx:hover .icon > i.fab, .small-boxx:hover .icon > i.fal, .small-boxx:hover .icon > i.fad, .small-boxx:hover .icon > i.ion {
            -webkit-transform: scale(1.1);
            transform: scale(1.1);
        }

        .small-boxx:hover .icon > svg {
            -webkit-transform: scale(1.1);
            transform: scale(1.1);
        }

    @@media (max-width: 767.98px) {
        .small-boxx {
            text-align: center;
        }

            .small-boxx .icon {
                display: none;
            }

            .small-boxx p {
                font-size: 12px;
            }
    }
</style>

<body style="overflow:hidden">
    <section class="content">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-md-12">
                    <div style="margin:5px;">
                        <button type="button" class="btn btn-dash" onclick="BtnSaveDashboard()" data-toggle="modal" style="padding:3px 15px;float:right;"><i class="fas fa-save"></i> Save </button>
                        <button type="button" class="btn btn-success" onclick="BtnBackDashboard()" style="padding: 4px 20px; float: right; margin-right: 5px; border-radius: 5px; font-weight: 400"><i class="fa fa-backward"></i> Back </button>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="page-container" style="width:100%">
                    <div class="panel-container">
                        <div class="panel-left card contact-trap" style="min-width: 21%;  width: 317px; height:520px;">
                            <div class="row" style="z-index:2">
                                <ul class="nav nav-tabs border-bottom-0" id="myTabInner" role="tablist">
                                    @foreach (var m in ViewBag.kpiItems)
                                    {
                                        <li class="nav-item">
                                            <a class="card1 nav-link" draggable="true" ondragstart="drag(event)" data-toggle="modal" data-target="#userdefine" data-id="@m.kpi_id" data-val-number="@m.chart_type" data-val="@m.kpi_query_id" data-data-val="@m.kpi_name">
                                                <div class="media">
                                                    <img class="mr-3 " src='@Url.Content(m.chart_image)' alt="Generic placeholder image" style="width:44px" />
                                                    <div class="media-body text-left">
                                                        <h5>@m.kpi_name</h5>
                                                        <input type="hidden" id="@m.kpi_id" name="@m.kpi_id" value="@m.json_property" />
                                                        <p>Correlations, proportions</p>
                                                    </div>
                                                </div>
                                            </a>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                        <div class="splitter"></div>
                        <div class="panel-right card" id="div2" style="min-width:25%; max-height:100%;">
                            <div id="container" class="frame no2" ondrop="drop(event)" ondragover="allowDrop(event)">
                                <div id="grid" class="grid-stack grid-stack-12"></div>
                            </div>
                            <div id="mySidebar" class="sidebar propertyBar" style="overflow-y: scroll">
                                @*<a href='javascript: void (0)' id="" class='closebtn' onclick='closeNav()'>×</a>
                                    <div id="mySidebar"></div>*@
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</body>

<!-- popup modal for save kpi charts -->
<div class="modal" id="saveDashboard_modal">
    <div class="modal-dialog">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title">Add New Dashboard</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="email" class="mb-1 mt-2"> Name </label>
                        <input type="text" class="form-control form-height" placeholder="Dashboard Name" id="Db_name" name="Db_name">
                        @*<span class="error">Name required</span>*@
                    </div>
                    <div class="form-group">
                        <label for="pwd" class="mb-1 mt-2">Description</label>
                        <input type="text" class="form-control form-height" placeholder="Description" id="Db_description" name="Db_description">
                    </div>
                    <div class="form-group">
                        <label for="pwd" class="mb-1 mt-2">User Type</label>
                        @Html.DropDownList("dashboard_user_type", new SelectList(ViewBag.UserRoleType, "Value", "Text"), new { @class = "form-control" })
                    </div>

                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="dashboardCheck">
                        <label class="form-check-label" for="dashboardCheck">Set as default</label>
                    </div>

                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="DBdarkmodeCheck">
                        <label class="form-check-label mt-1" for="DBdarkmodeCheck">Set as dark mode</label>
                    </div>


                </form>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">

                @*<input type="button" class="BtnSubmitDb btn btn-success" value="Submit" />*@

                <input type="button" class="BtnSubmitDb btn btn-success mt-2 pl-4 pr-4" value="Submit" />
                <button type="button" class="BtnCloseDb btn btn-danger pl-4 pr-4" data-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>
<!-- popup modal for preview kpi charts -->
<div class="modal" tabindex="-1" role="dialog" aria-hidden="true" id="previewChart_modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="width:100%">
            <div class="modal-header">
                <h3 class="modal-title">Charts Preview </h3>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Loading...</p>

            </div>
        </div>
    </div>
</div>

<script src="~/GraphStyles/js/adminlte.js"></script>
<script src="~/GraphStyles/GridStack/dist/jquery.min.js"></script>
<script src="~/Scripts/jquery-ui.js"></script>
<script src="~/GraphStyles/GridStack/dist/lodash.min.js"></script>
<script src="~/GraphStyles/GridStack/dist/gridstack.min.js"></script>
<script src="~/GraphStyles/js/spectrum.js"></script>
<script src="~/Scripts/Chart-js/chart.js"></script>
<script src="~/MasterStyles/js/StickyScript.js"></script>
<script src="~/Scripts/SweetAlert2/sweetalert2.all.min.js"></script>

<!--Click event for back, save and close button-->
<script>
    $(document).ready(function () {
        getViewbagData('@ViewBag.FontName', '@ViewBag.FontSize');
        //This function exists in "~/MasterStyles/js/StickyScript.js" file
        //All the functions of this view are inside the "~/MasterStyles/js/StickyScript.js" file
    });
    function BtnBackDashboard() {
        @*var dashboard_url = '@Url.Content("~/DashBoard/DashboardList")';*@
        var dashboard_url = '@Url.Content("~/Dynamic/Index?menu_name=Dashboard")';
        window.location.href = dashboard_url;
    }
    function BtnSaveDashboard() {
        var htmldata = $('#grid').html();
        if (htmldata == '') {
            //alert('Please plot atleast one chart on panel!!!');
            swal.fire({
                title: "Operation warning!",
                text: "Please plot atleast one chart on panel!",
                icon: "warning",
                button: "Ok",
            });
        }
        else {
            $('#saveDashboard_modal').modal('show');
        }
    }
    $('.BtnCloseDb').click(function () {
        $('#saveDashboard_modal').modal('hide');
        $('#Db_name').siblings('span.error').css('visibility', 'hidden');
        $('#Db_name').val('');
        $('#Db_description').val('');
     });
    $('.BtnSubmitDb').click(function () {
        var isAllValid = true;
        if ($('#Db_name').val().trim() == '') {
            isAllValid = false;
            $('#Db_name').siblings('span.error').css('visibility', 'visible');
        }
        else {
            $('#Db_name').siblings('span.error').css('visibility', 'hidden');
        }

        var list = [];
        var list1 = [];
        var finalObj = [];
        var items = $('.plainCard');
        $(items).each(function () {
            var keyid = $(this).attr("id");
            var current_sticky = null;
            //console.log("json_DataProperty:", json_DataProperty);
            var tmp_obj = json_DataProperty.find(o => o.key === keyid);

            if (tmp_obj != undefined && tmp_obj != null) {
                current_sticky = tmp_obj.value;
                var objData = {};
                //console.log("current_sticky", current_sticky);
                for (let i = 0; i < current_sticky.length; i++) {
                    //objData.push(
                    //    [current_sticky[i]["key"]], current_sticky[i]["value"]
                    //);
                    //objData.push({
                    //    key: current_sticky[i]["key"],
                    //    value: current_sticky[i]["value"]
                    //});

                    Object.assign(objData, { [current_sticky[i]["key"]]: current_sticky[i]["value"] });

                }

                objData = JSON.stringify(objData);
            }
            else {
                objData = null;
            }
            var chartItem = {
                kpi_id: $(this).attr("data-id"),
                chart_container: $(this).attr("id"),
                chart_type: $(this).attr("data-val-number"),
                kpi_query_id: $(this).attr("data-val"),
                chart_bottom: $(this).css("bottom"),
                chart_right: $(this).css("right"),
                chart_height: $(this).css("height"),
                chart_width: $(this).css("width"),
                chart_left: $(this).offset().left,
                chart_top: $(this).offset().top,
                kpi_property: objData
                //chart_top : $(this).css("top"),
                //chart_left: $(this).css("left"),
                //chart_bottom: $(this).offset().bottom,
                //chart_right: $(this).offset().right
                //chart_height: ($(this).height() / $(window).height())*100,
                //chart_width: ($(this).width() / $(window).width())*100
            }
            list.push(chartItem);
            console.log("list", list);
        });

        $('.grid-stack-item').each(function () {
            var kpiitems = {
                kpi_width: $(this).attr('data-gs-width'),
                kpi_height: $(this).attr('data-gs-height'),
                kpi_x: $(this).attr('data-gs-x'),
                kpi_y: $(this).attr('data-gs-y')
            }
            list1.push(kpiitems);
        });
        finalObj = mergeArrayObjects(list, list1);

        if (isAllValid) {
            var newDataVal = {
                dashboard_name: $("#Db_name").val().trim(),
                dashboard_description: $('#Db_description').val().trim(),
                defaultDashboard: $("#dashboardCheck").prop('checked'),
                dashboard_position: $("#DBdarkmodeCheck").prop('checked'),
                dashboard_user_id: $("#dashboard_user_type").val(),
                kpiList: finalObj
            }
            //console.log("newDataVal:", newDataVal);
            $.ajax({
                type: 'POST',
                url: '@Url.Content("~/DashBoard/DashboardSave")',
                data: JSON.stringify(newDataVal),
                contentType: 'application/json',
                success: function (data) {
                    if (data.startsWith("ERROR")) {
                        var res = data.split(";");
                        var error = '';
                        if (res.length > 1) {
                            error = res[1];
                        } else {
                            error = data;
                        }
                        //alert(error);
                        Swal.fire({
                            icon: "error",
                            title: "Oops...",
                            text: error
                        });

                    } else {
                        //alert('Data saved successfully!!!');
                        //$('#saveDashboard_modal').modal('hide');
                        var dashboard_url = '@Url.Content("~/Dynamic/Index?menu_name=Dashboard")';
                        Swal.fire({
                            icon: 'success',
                            title: 'Data inserted successfully!!!',
                            showConfirmButton: true,
                        }).then(function () {
                            $('#saveDashboard_modal').modal('hide');
                            window.location.href = dashboard_url;
                        });
                    }
                },
                error: function (error) {
                    //alert('Error');
                    Swal.fire({
                        icon: "error",
                        title: "Oops...",
                        text: "Something went wrong!"
                    });
                }
            });
        }
        else {
            //Swal.fire('Please fill the mandatory fields!!!');
            swal.fire({
                title: "Operation warning!",
                text: "Please fill the mandatory fields!",
                icon: "warning",
                button: "Ok",
            });
        }
    });
    function mergeArrayObjects(arr1, arr2) {
        return arr1.map((item, i) => {
            return Object.assign({}, item, arr2[i])
        })
    }
</script>
